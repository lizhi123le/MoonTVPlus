# Cloudflare D1 数据库初始化

MoonTV Plus 项目使用 Cloudflare D1 作为生产环境数据库。

## 快速初始化（全新部署）

### 1. 设置 GitHub Secrets

在 GitHub 仓库的 Settings → Secrets and variables → Actions 中添加：

| Secret 名称 | 说明 | 示例值 |
|------------|------|--------|
| `CLOUDFLARE_API_TOKEN` | Cloudflare API Token | `your_api_token` |
| `CLOUDFLARE_ACCOUNT_ID` | Cloudflare Account ID | `abc123` |
| `USERNAME` | 站长账号 | `admin` |
| `PASSWORD` | 站长密码 | `your_password` |
| `NEXT_PUBLIC_STORAGE_TYPE` | 存储类型 | `d1` |
| `D1_DATABASE_ID` | D1 数据库 ID | 从 Cloudflare Dashboard 获取 |

### 2. 触发部署

1. 进入仓库 Actions 页面
2. 选择 "Deploy to Cloudflare" workflow
3. 点击 "Run workflow"

部署流程会自动：
- ✅ 创建数据库表结构
- ✅ 自动创建初始站长用户（使用 `USERNAME` 和 `PASSWORD` secrets）

### 3. 验证初始化结果

部署成功后，执行以下命令验证：

```bash
# 查看用户
npx wrangler d1 execute moontvplus --command="SELECT username, role FROM users;" --remote

# 预期输出：显示设置的 USERNAME 用户
```

## 表结构（14个表）

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | `users` | 用户表 |
| 2 | `play_records` | 播放记录 |
| 3 | `favorites` | 收藏 |
| 4 | `search_history` | 搜索历史 |
| 5 | `skip_configs` | 跳过配置 |
| 6 | `danmaku_filter_configs` | 弹幕过滤 |
| 7 | `notifications` | 通知 |
| 8 | `movie_requests` | 求片请求 |
| 9 | `user_movie_requests` | 用户求片关联 |
| 10 | `global_config` | 全局配置 |
| 11 | `admin_config` | 管理员配置 |
| 12 | `favorite_check_times` | 收藏检查时间 |
| 13 | `music_play_records` | 音乐播放记录 |
| 14 | `music_playlists` | 音乐歌单 |

## 常用查询

```bash
# 查看所有表
npx wrangler d1 execute moontvplus --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;" --remote

# 查看用户
SELECT username, role, banned FROM users;

# 查看收藏
SELECT * FROM favorites WHERE username='your_username';

# 删除用户（级联删除所有数据）
DELETE FROM users WHERE username='username';

# 清空收藏
DELETE FROM favorites;
```

## 手动初始化（可选）

如果需要手动初始化，可以使用以下命令：

### 1. 初始化表结构

```bash
npx wrangler d1 execute moontvplus --file=./migrations/001_initial_schema.sql --remote
```

### 2. 手动创建站长用户

```bash
# 计算密码的 SHA-256 哈希
echo -n "your_password" | sha256sum

# 创建用户
npx wrangler d1 execute moontvplus --command="
INSERT INTO users (username, password_hash, role, banned, tags, oidc_sub, enabled_apis, created_at, playrecord_migrated, favorite_migrated, skip_migrated)
VALUES ('admin', 'your_password_hash', 'owner', 0, NULL, NULL, NULL, \$(date +%s), 1, 1, 1)
ON CONFLICT(username) DO UPDATE SET password_hash = 'your_password_hash', role = 'owner';
" --remote
```

## 故障排除

### "数据库操作失败" 错误

1. 检查是否已设置 `USERNAME` 和 `PASSWORD` secrets
2. 确认 GitHub Actions 部署已成功执行
3. 检查 D1 数据库是否存在

### 收藏功能失败

可能是 `favorites` 表缺少字段，执行迁移脚本修复：

```bash
npx wrangler d1 execute moontvplus --file=./migrations/001_initial_schema.sql --remote
```

## 相关资源

- [Cloudflare D1 文档](https://developers.cloudflare.com/d1/)
- [Wrangler CLI 命令](https://developers.cloudflare.com/workers/wrangler/)
